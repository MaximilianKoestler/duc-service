<!DOCTYPE html>
<head>
  <title>Storage Analyzer</title>
  <meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
        console.log("ready");
        
        /* Fetch list of databases and fill them into the list */
        $.ajax("get-databases.cgi", {
            success: function (data) {
              // Success callback function
              console.log(data)
              
              /* Delete the last one entry since it is always "0" */
              data.databases.pop()
        
              /* Extract the parameters from the URL */
              var db = (new URL(location.href)).searchParams.get('db')
              if (db == null) {
                console.log("No 'db' parameter in URL, selecting latest DB");
                db = data.databases[data.databases.length - 1]
              }                      
              console.log("Selected DB: " + db)
              
              var path = (new URL(location.href)).searchParams.get('path')
              console.log("Path: " + path)
              
              if (path == null) {
                path = "/scan"
              }

              list = document.getElementById("databases_list")     
              
              /* Iterate through the list */
              for(let i = 0; i < data.databases.length; i++) {
                console.log(i, data.databases[i]);
                let li = document.createElement('li');
                let arr = data.databases[i].replace("/database/duc_", "").replace(".db", "").replace("_", " ").split(" ")
                let formated = arr[0] + " " + arr[1].replaceAll("-", ":")
                
                let entry_class = "not_selected_snapshot"
                let a_class = ""
                if (data.databases[i] == db) {
                    entry_class = "selected_snapshot"
                    a_class = "selected_snapshot_link"
                }
                
                li.innerHTML = "<span class=" + entry_class + "><a class=\"snapshot_link " + a_class + "\" href=duc.cgi?db=" + data.databases[i] + "&cmd=index&path=" + path + ">" + formated + "</a></span>"
                li.className = "snapshot"                        
                list.appendChild(li);
              }
              
            },
            error: function (xhr, ajaxOptions, thrownError) {
              // Error callback
              console.log("Error, failed to fetch get-databases.cgi: " + xhr.status + ", " + thrownError + "!");
              document.getElementById("databases").innerHTML = "Failed to read the list of snapshots!<br>Error: " + xhr.status + ", " + thrownError + "!"
            },
        });


        /* Check if the path parameter is provided in the URL and use it */
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        var path = "";
        if (urlParams.has('path')) {
            path = urlParams.get('path');
            console.log("path: " + path);
        }
        
        document.getElementById("path").innerHTML = path;

        var db = "";
        if (urlParams.has('db')) {
            db = urlParams.get('db');
            console.log("DB: " + db);
        }

        document.getElementById("folder_up_button").href = "duc.cgi?db=" + db + "&cmd=index&path=" + path.split("/").slice(0, -1).join("/")


        
    })
  </script>


  <div id=sidebar>
      <div style="padding: 0;  margin-bottom: 20px;">
          <div style="padding: 0;"><a href="/"><img src=logo.png width=70px style="float: left; padding-left: 0"></a></div>
          <div style="float: none; margin-left: 70px;"><a href="/" style="text-decoration: none"><h1>Storage Analyzer</h1></a></div>
      </div>
      <h2 style="margin-bottom: 0; margin-left: 10px;">Snapshots</h2>
      <div id=databases><ul id="databases_list" style="margin:0"></ul></div>
      <p>More: <a href=https://github.com/MaximilianKoestler/duc-service target=_blank>github.com/MaximilianKoestler/duc-service</a></p>
      <p>Based on &nbsp;<a href=https://duc.zevv.nl/ target=_blank alt=Duc><img src=duc.png width=70px style="vertical-align:middle" ></a></p>
      <p>Icon source: <a href="https://www.flaticon.com/free-icon/storage-space_8110605" title="storage space icons" target=_blank>Storage space icons created by Freepik - Flaticon</a></p>
  </div>
  <div id=content style="float: left;">
    <div id=error>
      <h2 class=error>Error</h2>
      <p class=error>The selected path can not be found in this snapshot: <span id="path"></span>!</p>
      <p><a href="" id="folder_up_button">Go one folder higher</a></p>
    </div>
  </div>
</body>
</html>
